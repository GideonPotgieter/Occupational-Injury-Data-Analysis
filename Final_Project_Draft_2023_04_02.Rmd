---
title: "Final Project: Draft 1"
author: "Gideon Potgieter"
date: "April 2, 2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
install.packages("rlang")
library(tidyverse)
library(knitr)  
library(ggpubr)
library(ggrepel)
library(tidyverse)
library(kableExtra)
library(survey)
library(haven)
library(broom)
library(plotrix)
library(patchwork)
library(pander)
library(dagitty)

```

### Question of interest

What risk factors are associated with experiencing an occupational injury?

### Data

For this project, I am using the Quality of Worklife (QWL) survey data, which is a part of the General Social Survey questionnaire for adults who have been employed in the United States in the past year. Here is the link to the [The General Social Survey website](https://gss.norc.org/Pages/quality-of-worklife.aspx){target="_blank"}.

Download your data and upload it into the data folder in this project. That way when we clone your repository for grading, we can knit your file.

Note: If you are using data that can't be shared publicly, please reach out to us to discuss the best way to work with your data. Do NOT upload your data to Github!

```{r data, include = FALSE}
dat <- read_sav('data/NIOSH-QWL.sav')
                
dat2014 <- dat %>% filter(year == "2014")

dat2014 <- dat2014 %>% select(occupation = occ2, sex, age, safetywk, safefrst, teamsafe, safehlth, wkinjury, wtssnr, health)

dat2014 <- drop_na(dat2014)

dat2014 <- dat2014 %>% 
  mutate(occupation=factor(occupation, levels=c(1, 2, 3, 4, 5), labels=c('White Collar', 'Blue Collar','Service', 'Farming/Fishing/Forestry', 'Military')),
         safetywk=factor(safetywk, levels=c(1, 2, 3, 4), labels=c('Strongly Agree', 'Agree', 'Disagree', 'Strongly Disagree'))) 
  

# Survey Weights design                        
work_injury_design <- svydesign(
  id = ~1,
  weights = ~dat2014$wtssnr,
  data = dat2014
) 
WI_design_nona <- subset(work_injury_design, complete.cases(dat2014))
```

```{r}
Table_1 <- dat2014 %>%
  count(wkinjury, occupation) %>%
  group_by(occupation) %>%
  mutate(prop = n/sum(n)) %>%
   mutate(percent =round(n/sum(n)*100,1))

Table_1 %>%
  filter(wkinjury == 1) %>%
  ggplot() +
  geom_bar(mapping = aes(x = occupation, y = percent), stat = "identity") + 
   geom_text(aes(x = occupation, y = percent, label = percent)) +
  labs(y= "% Injured",
       x= "Occupation",
       title= "% of workers who had an occupational injury in the past year")

Table_2 <- dat2014 %>%
  count(wkinjury, safetywk) %>%
  group_by(safetywk) %>%
  mutate(prop = n/sum(n)) %>%
   mutate(percent =round(n/sum(n)*100,1))

Table_2 %>%
  filter(wkinjury == 1) %>%
  ggplot() +
  geom_bar(mapping = aes(x = safetywk, y = percent), stat = "identity") + 
   geom_text(aes(x = safetywk, y = percent, label = percent)) +
  labs(y= "% Injured",
       x= "Answer to: Does worker safety take high priority at my job?",
       title= "% of workers who had an occupational injury by perception of workplace safety")
```

### Variables of interest

* **Outcome variable: Whether respondent had Occupational Injuries in the past year (wkinjury)**
* **Primary predictor variable: Industry/job type, Race, Income**
* **Possible confounders: Age, Sex**
* **Potential effect modifiers: Age, Sex**

### Directed acyclic graph (DAG)
```{r}

```

### Analysis plan

Logistic regression would make sense as the outcome is simply whether or not the respondent had experienced an occupational injury in the past year.
```{r}
#Survey weighted logistic regression

g1 <- svyglm(wkinjury ~ 
               age + sex + occupation + health,
              family = quasibinomial(link = 'logit'), 
             design = work_injury_design)

g1 %>%
  tidy(exponentiate = TRUE, conf.int = TRUE, conf.level = 0.96) %>%
  filter(term != "(Intercept)") %>%
  mutate(conf.int = paste0("(", round(conf.low,2), ", ", round(conf.high,2), ")")) %>%
  select(Term = term, OR = estimate, `p-value` = p.value, `95% CI` = conf.int) %>%
  mutate(Term=c("Age", "Sex", "Blue Collar", "Service", "Fishing/Farming/Forestry", "Military", "Overall Health"))%>%
  pander(digits = 2)

g2 <- svyglm(wkinjury ~ 
               age + sex + safetywk + health,
              family = quasibinomial(link = 'logit'), 
             design = work_injury_design)

g2 %>%
  tidy(exponentiate = TRUE, conf.int = TRUE, conf.level = 0.96) %>%
  filter(term != "(Intercept)") %>%
  mutate(conf.int = paste0("(", round(conf.low,2), ", ", round(conf.high,2), ")")) %>%
  select(Term = term, OR = estimate, `p-value` = p.value, `95% CI` = conf.int) %>%
  mutate(Term=c("Age", "Sex", "agree", "disagree", "strongly disagree", "Hours worked"))%>%
  pander(digits = 2)

```

What type of basic analysis could you use to address your question of interest?  Linear regression because your outcome is continuous?  Logistic regression because your outcome is binary?  How will you control for confounding in your analysis?  This section may change and be updated later as you continue with your analysis.



```{r submission_instructions, include=FALSE, eval=FALSE}
REMINDER:  When you are ready to submit your assignment, do ALL of the following:

* First, knit your .Rmd file to see if it will compile.  If it doesn't knit, you can still follow the steps below to submit your assignment, but please try to resolve the knitting issues before you submit.  You can reach out to us at phbiostats@jhu.edu for help!
* Next you need to **commit** the changes you've made to the document.  Click the colorful Git button at the top of the RStudio window and select "Commit" from the menu.
* In the window that opens, **stage** your changes by clicking the check boxes next to the Rmd file.
* In the "Commit message" box, type a short description of what changes you've made, something like: `Completed assignment`
* Click the "Commit" button on the bottom right.
* You'll see a window that will tell you about the changes that you've made.  Click "Close" to close the window.  You've successfully committed! You can close this commit window now.
* After committing, you must **push** your changes to the repository on Github.  Do this by clicking the colorful Git button again and select "Push Branch".  
* Again, you'll see a window open that tells you your changes have been pushed!
* If you want, you can look at your repository on [Github.com](https://github.com/) and should be able to see your changes there!  
* You've successfully submitted your assignment :)
```
